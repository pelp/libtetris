<!doctype html>
<html lang="en-us">
    <style>
        @font-face {
            font-family: Calculator;
            src: url(digital-7.mono.ttf);
        }
        * {
            box-sizing: border-box;
        }
        body {
            --info-font: 'Calculator', sans-serif;
            --game-font: monospace;
            --cover-color: #999;
            --uncover-color: #CCC;
            --background-color: url("https://www.sixt.se/magazine/wp-content/uploads//sites/14/2021/10/Stockholms_skargard_Roslagen.jpg");
            margin: 0;
            padding: 0;
            background: var(--background-color);
            background-size: cover;
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100vw;
            height: 100vh;
        }
        .wrapper {
            display: flex;
            align-items: center;
            flex-direction: column;
            width: fit-content;
        }
        .game {
            display: flex;
            align-items: stretch;
        }
        .game > div {
            background: var(--cover-color);
            border-style: outset;
            border-color: var(--uncover-color);
            border-width: 3.5px;
            box-shadow: 0px 5px 5px rgba(0, 0, 0, 0.4);
            padding: 5px;
        }
        .leaderboard {
            margin-left: 5px;
            display: flex;
            flex-direction: column;
            align-items: stretch;
        }
        .leaderboard > input {
            font-family: var(--info-font);
            width: 100px;
            border-style: inset;
            border-color: var(--uncover-color);
            border-width: 3.5px;
            background: black;
            color: red;
            font-size: 20px;
            height: 30px;
        }
        .leaderboard > div {
            font-family: var(--info-font);
            margin-top: 5px;
            border-style: inset;
            border-color: var(--uncover-color);
            border-width: 3.5px;
            color: red;
            background: black;
            flex-grow: 1;
            color: red;
            display: flex;
            flex-direction: column;
        }
        .leaderboard > .shape {
            margin-top: 0;
            margin-bottom: 5px;
            flex-grow: 0;
        }
        .leaderboard > div > span > span:nth-child(1) {
            float: left;
        }
        .leaderboard > div > span > span:nth-child(2) {
            float: right;
        }
        .info_wrapper {
            width: 100%;
            background: var(--cover-color);
            border-style: inset;
            border-color: var(--uncover-color);
            border-width: 3.5px;
            margin-bottom: 5px;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            padding: 2px;
        }
        .info_wrapper > div {
            border-style: outset;
            border-color: var(--uncover-color);
            border-width: 3.5px;
            user-select: none;
            font-family: var(--info-font);
        }
        .dificulty_wrapper {
            display: grid;
            grid-template-columns: auto auto;
            grid-template-rows: auto auto;
            grid-auto-flow: column;
        }
        .dificulty_wrapper > div {
            border-style: outset;
            border-color: var(--uncover-color);
            border-width: 3.5px;
        }
        .dificulty_wrapper > div:active {
            border-style: inset;
            border-color: var(--uncover-color);
            border-width: 3.5px;
        }
        .dificulty_wrapper > div:hover {
            cursor: pointer;
        }
        .text_info {
            font-size: 40px;
            text-align: right;
        }
        .text_info > div {
            height: 40px;
            padding: 2px;
            padding-top: 1px;
            border-style: inset;
            border-color: var(--uncover-color);
            border-width: 3.5px;
            color: red;
            background: black;
        }
        .restart {
            vertical-align: middle;
            font-size: 30px;
            text-align: center;
            padding: 2px;
        }
        .restart:hover {
            cursor: pointer;
        }
        .restart:active {
            border-style: inset;
        }
        .grid_wrapper {
            display: grid;
            grid-gap: 0px;
            align-items: center;
            justify-items: center;
            width: fit-content;
            border-style: inset;
            border-color: var(--uncover-color);
            border-width: 3.5px;
            font-family: var(--game-font);
            font-size: 20px;
            font-weight: bold;
            background: black;
        }
        .square {
            background: black;
            height: 30px;
            width: 30px;
            border-width: 5px;
            border-style: none;
        }
        .square[data-tile="1"] {
            border-style: outset;
            background-color: yellow;
            border-color: yellow;
        }
        .square[data-tile="2"] {
            border-style: outset;
            background-color: cyan;
            border-color: cyan;
        }
        .square[data-tile="3"] {
            border-style: outset;
            background-color: blue;
            border-color: blue;
        }
        .square[data-tile="4"] {
            border-style: outset;
            background-color: orange;
            border-color: orange;
        }
        .square[data-tile="5"] {
            border-style: outset;
            background-color: red;
            border-color: red;
        }
        .square[data-tile="6"] {
            border-style: outset;
            background-color: lime;
            border-color: lime;
        }
        .square[data-tile="7"] {
            border-style: outset;
            background-color: magenta;
            border-color: magenta;
        }
        .square[data-tile="10"] {
            border-style: outset;
            background-color: black;
            border-color: gray;
			border-style: dashed;
			border-width: 2px;
        }
        .shape {
            height: 75px;
            border-style: inset;
            border-color: var(--uncover-color);
            border-width: 3.5px;
            background: black;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
        }
        .shape > div {
            display: grid;
            grid-gap: 0px;
            align-items: center;
            justify-items: center;
            width: fit-content;
        }
        .shape > div > div {
            width: 15px;
            height: 15px;
            border-width: 3px;
        }
    </style>
    <script type='text/javascript'>
        // TODO: Add next piece indicator
        var Module = {}
        const generate_html = (width, height) => {
            const elements = [];
            const shape_elements = [];
            const game = document.createElement("div");
            const wrapper = document.createElement("div");

            const info_wrapper = document.createElement("div");
            const lines_display = document.createElement("div");
            const smiley_display = document.createElement("div");

            const easy = document.createElement("div");
            const medium = document.createElement("div");
            const hard = document.createElement("div");
            const expert = document.createElement("div");

            const lb_wrapper = document.createElement("div");
            const leaderboard = document.createElement("div");
            const name_input = document.createElement("input");
            const local_name = window.localStorage.getItem("name");
            if (local_name === null) {
                name_input.value = "anonymous";
            } else {
                name_input.value = local_name;
            }
            name_input.onchange = event => {
                window.localStorage.setItem("name", name_input.value);
            };

            const updateLeaderboard = (scores) => {
                leaderboard.innerHTML = "";
                scores.forEach((person, _) => {
                    const span = document.createElement("span");
                    const n = document.createElement("span");
                    const t = document.createElement("span");
                    span.appendChild(n);
                    span.appendChild(t);
                    n.innerHTML = person[0];
                    t.innerHTML = person[1];
                    leaderboard.appendChild(span);
                });
            };

            // Setup WebSocket for leaderboard
            const ws_link = (window.location.protocol === "http:") ?
                `ws://${window.location.hostname}:8763` :
                `wss://${window.location.hostname}/ws`;
            const socket = new WebSocket(ws_link);
            socket.onmessage = event => {
                updateLeaderboard(JSON.parse(event.data));
            };

            const shape = document.createElement("div");
            // shape.classList.add("grid_wrapper");
            shape.classList.add("shape");

            game.classList.add("game");
            lb_wrapper.classList.add("leaderboard");
            lb_wrapper.appendChild(shape);
            lb_wrapper.appendChild(name_input);
            lb_wrapper.appendChild(leaderboard);

            smiley_display.classList.add("restart");
            lines_display.classList.add("text_info");
            const lines_span = document.createElement("div");
            lines_display.appendChild(lines_span);

            const shape_wrapper = document.createElement("div");
            shape.appendChild(shape_wrapper);

            let old_w = 0;
            let old_h = 0;

            const render = () => {
                const ptr = Module._js_get();
                lines_span.innerHTML = Module._js_lines().toString().padStart(3, '0');
                elements.forEach((e, i) => {
                    e.dataset.tile = Module.HEAP8[i + ptr];
                });

                const shape_width = Module._js_next_width();
                const shape_height = Module._js_next_height();
                if (!(old_w == shape_width && old_h == shape_height)) {
                    old_w = shape_width;
                    old_h = shape_height;
                    shape_wrapper.innerHTML = "";
                    shape_wrapper.style.gridTemplateRows = "auto ".repeat(shape_height);
                    shape_wrapper.style.gridTemplateColumns = "auto ".repeat(shape_width);
                    shape_elements.length = 0;
                    for (let i = 0; i < shape_height; i++) {
                        const line = document.createElement("div");
                        for (let j = 0; j < shape_width; j++) {
                            const e = document.createElement("div");
                            e.classList.add("square");
                            shape_wrapper.appendChild(e);
                            shape_elements.push(e);
                        }
                    }
                }
                const shape_ptr = Module._js_next();

                shape_elements.forEach((e, i) => {
                    e.dataset.tile = Module.HEAP8[i + shape_ptr];
                });
            };

            const handle = rc => {
                switch (rc) {
                    case 0:
                        return 0;
                    case 1:
                        playing = false;
                        postScore();
                        return 1;
                    case 2:
                        return 1;
                }
            };
            const timeout = () => {
                if (playing) {
                    handle(Module._js_step());
                    render();
                }
                setTimeout(timeout, 1000 - 10 * Module._js_lines());
            };
            setTimeout(timeout, 1000);

            const restart = () => {
                playing = true;
                Module._js_init(width, height);
                smiley_display.innerHTML = "Restart";
                render();
            };

            restart();

            wrapper.classList.add("wrapper");

            const postScore = () => {
                const lines = Module._js_lines();
                const name = name_input.value.toLowerCase();
                socket.send(JSON.stringify([name, lines]));
            };

            // Generate info
            smiley_display.onclick = event => {
                restart();
            };

            info_wrapper.appendChild(lines_display);
            info_wrapper.appendChild(smiley_display);

            info_wrapper.classList.add("info_wrapper");
            wrapper.appendChild(info_wrapper);

            // Generate grid
            const grid_wrapper = document.createElement("div");
            grid_wrapper.classList.add("grid_wrapper");

            const generate_grid = () => {
                grid_wrapper.innerHTML = "";
                grid_wrapper.style.gridTemplateRows = "auto ".repeat(height);
                grid_wrapper.style.gridTemplateColumns = "auto ".repeat(width);
                elements.length = 0;

                for (let i = 0; i < height; i++) {
                    const line = document.createElement("div");
                    for (let j = 0; j < width; j++) {
                        const e = document.createElement("div");
                        e.classList.add("square");
                        grid_wrapper.appendChild(e);
                        elements.push(e);
                    }
                }
                wrapper.appendChild(grid_wrapper);
                game.appendChild(wrapper);
                game.appendChild(lb_wrapper);
                document.body.appendChild(game);
            };

            generate_grid();

            render();
            socket.onopen = event => {
                const d = 'default'; //window.localStorage.getItem("difficulty");
                socket.send(JSON.stringify([d]));
            };
            return [render, handle];
        };
        let width = 10;
        let height = 20;
        let playing = true;
        Module.print = text => {
            console.log(text);
        };
        Module.onRuntimeInitialized = event => {
            const [render, handle] = generate_html(width, height);
            document.onkeydown = event => {
                if (!playing) return; // Guard against not playing
                switch (event.keyCode)
                {
                    case 32: // Space
                        event.stopPropagation();
                        event.preventDefault();
                        while (handle(Module._js_step()) == 0);
                        render();
                        break;
                    case 37: //Left arrow
                        event.stopPropagation();
                        event.preventDefault();
                        Module._js_left();
                        render();
                        break;
                    case 38: // Up arrow
                        event.stopPropagation();
                        event.preventDefault();
                        Module._js_rotate();
                        render();
                        break;
                    case 39: // Right arrow
                        event.stopPropagation();
                        event.preventDefault();
                        Module._js_right();
                        render();
                        break;
                    case 40:
                        event.stopPropagation();
                        event.preventDefault();
                        handle(Module._js_step());
                        render();
                        break;
                }
            };
        };
    </script>
    {{{ SCRIPT }}}
  </body>
</html>
